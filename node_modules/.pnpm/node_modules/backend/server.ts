import express from "express";
import cors from "cors";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();
const app = express();
app.use(cors());
app.use(express.json());

const PORT = 4000;

// ===== Test endpoint =====
app.get("/", (_req, res) => {
  res.send("Backend b캩쮂 游녨");
});

// ===== Healthcheck =====
app.get("/health", (_req, res) => {
  res.json({ ok: true, ts: new Date().toISOString() });
});

// ===== GET /tables =====
app.get("/tables", async (_req, res) => {
  try {
    const allTables = await prisma.tableEntity.findMany();

    const response = allTables.map(t => ({
      id: t.id,
      data: t.data,
    }));

    res.json(response);
  } catch (err) {
    console.error("Chyba p콏i na캜칤t치n칤 tabulek:", err);
    res.status(500).json({ error: "Server error" });
  }
});

// ===== POST /tables =====
app.post("/tables", async (req, res) => {
  console.log("Frontend pos칤l치 data:", req.body);

  try {
    const { name, data } = req.body;

    if (!name || !data) return res.status(400).json({ error: "Missing name or data" });

    const record = await prisma.tableEntity.create({
      data: { name, data },
    });

    res.json({ ok: true, savedId: record.id });
  } catch (err) {
    console.error("Chyba p콏i ukl치d치n칤 tabulky:", err);
    res.status(500).json({ error: "Server error" });
  }
});

// ===== PUT /tables/:id =====
app.put("/tables/:id", async (req, res) => {
  const { id } = req.params;
  const { name, data } = req.body;

  if (!name || !data) return res.status(400).json({ error: "Missing name or data" });

  try {
    const updated = await prisma.tableEntity.update({
      where: { id },
      data: { name, data },
    });
    res.json({ ok: true, updatedId: updated.id });
  } catch (err) {
    console.error("Chyba p콏i aktualizaci tabulky:", err);
    res.status(500).json({ error: "Server error" });
  }
});

// ===== DELETE /tables/:id =====
app.delete("/tables/:id", async (req, res) => {
  const { id } = req.params;
  try {
    await prisma.tableEntity.delete({ where: { id } });
    res.json({ ok: true });
  } catch (err) {
    console.error("Chyba p콏i maz치n칤 tabulky:", err);
    res.status(500).json({ error: "Server error" });
  }
});

// ===== Spu코t캩n칤 serveru =====
app.listen(PORT, () => console.log(`Backend b캩쮂 na http://localhost:${PORT}`));
